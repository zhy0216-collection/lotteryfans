_ = require("underscore");



var People = function(id, name, selected){
    this.id = id;
    this.name = name;
    this.selected = selected || false;


    return this;
}





var PeopleList = function(){
    var self = this;
    var _peopleList = [];

    self.initFromFile = function(filename){
        var fs = require('fs');
        fs.readFile('./res/people_list', 'utf8', function (err,data) {
          if (err) {
            return console.log(err);
          }

          var peopleData = data.split("\n");
          
          _.each(peopleData, function(v, i){
                var temp = v.split("\t");
                var people = new People(temp[0], temp[1]);
                self.addPeople(people);
          })
        });

        return self;
    }

    self.addPeople = function(people){
        _peopleList.push(people);
    }

    self.getPeopleList = function(){
        return _peopleList;
    }

    self.length = function(){
        return _peopleList.length
    }

    self.randomSelect = function(selected){
        selected = selected || false;
        var unselectPeople = self.getUnselectPeople();
        var people = _.sample(unselectPeople)
        people.selected = selected;
        return people;
    }

    self.getUnselectPeople = function(){
        return _.reject(_peopleList, function(people){
            return people.selected
        })
    }

    self.getSelectPeople = function(){
        return _.filter(_peopleList, function(people){
            return people.selected
        })
    }

    self.save = function(){
        window.localStorage.peopleList = JSON.stringify(_peopleList);
        return self;
    }

    self.backup = function(){
        var now = new Date();
        window.localStorage[now] = JSON.stringify(_peopleList);
        return self;
    }


    return self;


}


function restore(){
    if(!window.localStorage.peopleList){
        return null;
    }
    var peopleData = JSON.parse(window.localStorage.peopleList)
    var peopleList = new PeopleList();
    _.each(peopleData, function(element, index, list){
        var people = new People(element.id, element.name, element.selected);
        peopleList.addPeople(people);
    })
    return peopleList;
}


exports.People = People;
exports.PeopleList = PeopleList;
exports.restore = restore;


