_ = require("underscore");



var People = function(id, name, selected){
    this.id = id;
    this.name = name;
    this.selected = selected || false;


    return this;
}





var PeopleList = function(){
    var self = this;
    var _peopleList = [];

    self.addPeople = function(people){
        _peopleList.push(people);
    }

    self.getPeopleList = function(){
        return _peopleList;
    }

    self.length = function(){
        return _peopleList.length
    }

    self.randomSelect = function(selected){
        selected = selected || false;
        var unselectPeople = self.getUnselectPeople();
        var people = _.sample(unselectPeople)
        people.selected = selected;
        return people;
    }

    self.randomSelectByLastTwoDigits = function(selected, number){ // number == int
        selected = selected || false;
        var unselectPeople = self.getUnselectPeople();
        var tempList = _.filter(unselectPeople, function(people){
                return people.id % 100 == number 
        })

        _.each(tempList, function(element){
            element.selected = selected;
        })

        return tempList;
        
    }

    self.isLastTwoDigitsSelected = function(digit0, digit1){
        var number = 10*digit0 + digit1;
        var tempList = _.filter(self.getSelectPeople(), function(people){
                return people.id % 100 == number 
        })

        return tempList.length >= 25;

    }

    self.isLastDigitSelected = function(digit0){
        for(var i=0; i < 10; i++){
            if(!self.isLastTwoDigitsSelected(digit0, i)){
                return false;
            }
        }
        return true;


    }

    self.genTwoRandomDigits = function(){
        // return string
        var digit1 = _.sample(_.range(10)); // lastone
        var digit0 = _.sample(_.range(10)); // second lastone
        return (digit0 * 10 + digit1 ).toString();
    }

    self.getUnselectPeople = function(){
        return _.reject(_peopleList, function(people){
            return people.selected
        })
    }

    self.getSelectPeople = function(){
        return _.filter(_peopleList, function(people){
            return people.selected
        })
    }

    self.save = function(){
        window.localStorage.peopleList = JSON.stringify(_peopleList);
        return self;
    }

    self.backup = function(){
        var now = new Date();
        window.localStorage[now] = JSON.stringify(_peopleList);
        return self;
    }


    return self;


}


function restore(){
    if(!window.localStorage.peopleList){
        return null;
    }
    var peopleData = JSON.parse(window.localStorage.peopleList)
    var peopleList = new PeopleList();
    _.each(peopleData, function(element, index, list){
        var people = new People(element.id, element.name, element.selected);
        peopleList.addPeople(people);
    })
    return peopleList;
}


exports.People = People;
exports.PeopleList = PeopleList;
exports.restore = restore;


