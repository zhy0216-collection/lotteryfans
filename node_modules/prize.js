_ = require("underscore");
swig = require("swig");
$ = global.$;





function Prize(image, degree, peopleList, selectPerTime, prizeName){
    var self = this;
    self.tpl = swig.compile($("#prizeTemplate").html());
    self.curSlide = null;
    self.numbersTpl = swig.compile($("#numbersTemplate").html());
    self.selectNumber = [];
    self.prizeName = prizeName;


    self.init = function(image, degree, peopleList, selectPerTime, prizeName){
        self.image = image;
        self.degree = degree;
        self.peopleList = peopleList;
        self.selectPerTime = selectPerTime;
    }

    self.show = function(){
        var content = self.tpl({prize:self});
        var $container = $("#container");
        $container.html(content);
        // $(".prize-show", $container).hide();
        self.curSlide = $(".slide", $container).first();
        self.showPrizePreview();
    }

    self.showPrizeProcess = function(){
        var $container = $("#container");
        $(".slide", $container).first().hide().next().show();
    }

    self.showPrizePreview = function(){
        var $container = $("#container");
        $(".slide", $container).first().show().next().hide();
    }

    self.run = function(running){
        if(running){
            self._randomSelect(self.selectPerTime);
            if(self.isFinish()){
                window.clearInterval(running);
                self.save()
                running = false;
            }
        }else{
            running = window.setInterval(function(){

                        self._randomNumberGen();


          }, 1)
        }
        return running
    }

    self._randomSelect = function(chooseTime){
        console.log("start");
        if(self.peopleList.getUnselectPeople().length < 1000){ // only for test
            var r= window.confirm("it seems almost everyone gets a prize. do you wanna restart?");
            if (r==true){
                self.peopleList.backup();
                window.localStorage.removeItem("peopleList");
                _.each(self.peopleList.getSelectPeople(), function(element){
                    element.selected = false;
                })
            }
        }

        var digit0 = 0;
        var digit1 = 0;
        for(var i =0; i < chooseTime; i++){
            while(1){
                digit0 = self.randomNumber();
                digit1 = self.randomNumber();
                var _people = self.peopleList.randomSelectByLastTwoDigits(false, 10*digit0 + digit1);
                if(_people.length != 0){
                    self.peopleList.randomSelectByLastTwoDigits(self.prizeName, 10*digit0 + digit1);
                    break;
                }
                
            }
        
            self.selectNumber.push([digit0, digit1]);
        }
    }

    self.numbers = function(){
        return _.range(self.degree);
    }

    self.randomNumber = function(){
        return _.sample(_.range(9 +1))
    }

    self.isFinish = function(){
        return self.selectNumber.length >= self.numbers().length;
    }

    self._randomNumberGen = function(){
        if(self.isFinish()){
            self.selectNumber = [];
        }

        var content = self.numbersTpl({prize:self});
        $(".prize-program").html(content)
    }

    self.save = function(){
        self.peopleList.save();
    }


    self.init(image, degree, peopleList, selectPerTime, prizeName);

    return self

}


function SpecialPrize(image, degree, peopleList, selectPerTime, prizeName){
    var prize = new Prize(image, degree, peopleList, selectPerTime, prizeName);
    prize.numbersTpl = swig.compile($("#specialNumbersTemplate").html());

    prize.randomNumber = function(){
        var number = _.sample(_.range(1, global.limit + 1));
        return number;
    }

    prize._randomSelect = function(chooseTime){
        for(var i =0; i < chooseTime; i++){
            var people = prize.peopleList.randomSelect(prize.prizeName);
            prize.selectNumber.push(people.id);
        }
    }

    prize._randomNumberGen = function(){
        if(prize.isFinish()){
            prize.selectNumber = [];
        }
        var content = prize.numbersTpl({prize:prize});
        $(".prize-program").html(content)
    }

    return prize

}



exports.Prize = Prize;
exports.SpecialPrize = SpecialPrize;

