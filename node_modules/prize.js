_ = require("underscore");
_.str = require('underscore.string');
_.mixin(_.str.exports());
swig = require("swig");
$ = global.$;





function Prize(image, degree, peopleList, selectPerTime, prizeName){
    var self = this;
    self.tpl = swig.compile($("#prizeTemplate").html());
    self.curSlide = null;
    self.numbersTpl = swig.compile($("#numbersTemplate").html());
    //startTemplate
    self.startTemplate = swig.compile($("#startTemplate").html());
    self.selectNumber = [];
    self.prizeName = prizeName;


    self.init = function(image, degree, peopleList, selectPerTime, prizeName){
        self.image = image;
        self.degree = degree;
        self.peopleList = peopleList;
        self.selectPerTime = selectPerTime;
    }

    self.show = function(){
        var content = self.tpl({prize:self});
        var $container = $("#container");
        $container.html(content);
        // $(".prize-show", $container).hide();
        self.curSlide = $(".slide", $container).first();
        self.showPrizePreview();
    }

    self.showPrizeProcess = function(){
        var $container = $("#container");
        var content = self.startTemplate({prize:self});
        $(".prize-program").html(content)
        $(".slide", $container).first().hide().next().show();
    }

    self.showPrizePreview = function(){
        var $container = $("#container");
        $(".slide", $container).first().show().next().hide();
    }


    self.run = function(running){
        if(running){
            self._randomSelect(self.selectPerTime);
            if(self.isFinish()){
                window.clearInterval(running);
                self.save()
                var content = self.numbersTpl({prize:self});
                $(".prize-program").html(content)
                running = false;
            }else{}
            
        }else{
            running = window.setInterval(function(){

                        self._randomNumberGen();


          }, 1)
        }
        return running
    }

    self._randomSelect = function(chooseTime){
        console.log("start");
        if(self.peopleList.getUnselectPeople().length < 1000){ // only for test
            var r= window.confirm("it seems almost everyone gets a prize. do you wanna restart?");
            if (r==true){
                self.peopleList.backup();
                window.localStorage.removeItem("peopleList");
                _.each(self.peopleList.getSelectPeople(), function(element){
                    element.selected = false;
                })
            }
        }

        var digit0 = 0;
        var digit1 = 0;
        for(var i =0; i < chooseTime; i++){
            while(1){
                digit0 = self.randomNumber();
                digit1 = self.randomNumber();
                var _people = self.peopleList.randomSelectByLastTwoDigits(false, 10*digit0 + digit1);
                console.log("number:"+ (10*digit0 + digit1) + "==>" + _people.length)
                if(_people.length < 30){
                    self.peopleList.randomSelectByLastTwoDigits(self.prizeName, 10*digit0 + digit1);
                    break;
                }
                
            }
        
            self.selectNumber.push([digit0, digit1]);
            console.log("self.selectNumber:" + self.selectNumber);
            console.log(self.selectNumber);
        }
    }

    self.numbers = function(){
        return _.range(self.degree);
    }

    self.randomNumber = function(){
        return _.sample(_.range(9 +1))
    }

    self.isFinish = function(){
        return self.selectNumber.length >= self.numbers().length;
    }

    self._randomNumberGen = function(){
        console.log("_randomNumberGen")
        if(self.isFinish()){
            self.selectNumber = [];
        }

        var content = self.numbersTpl({prize:self});
        $(".prize-program").html(content)
    }

    self.save = function(){
        self.peopleList.save();
    }


    self.init(image, degree, peopleList, selectPerTime, prizeName);

    return self

}


function SpecialPrize(image, degree, peopleList, selectPerTime, prizeName){
    var prize = new Prize(image, degree, peopleList, selectPerTime, prizeName);
    prize.numbersTpl = swig.compile($("#specialNumbersTemplate").html());
    prize.startTemplate = swig.compile($("#specialStartTemplate").html());

    prize.randomNumber = function(){
        var number = _.sample(_.range(1, global.limit + 1));
        return number;
    }

    prize._randomSelect = function(chooseTime){
        for(var i =0; i < chooseTime; i++){
            var people = prize.peopleList.randomSelect(prize.prizeName);
            prize.selectNumber.push(_.lpad(people.id, 4, "0"));
        }
    }

    prize._randomNumberGen = function(){
        if(prize.isFinish()){
            prize.selectNumber = [];
        }
        var content = prize.numbersTpl({prize:prize});
        $(".prize-program").html(content)
    }

    return prize

}

function SinglePrize(image, degree, peopleList, selectPerTime, prizeName){
    var prize = new Prize(image, 1, peopleList, 1, prizeName);
    prize.numbersTpl = swig.compile($("#singleNumbersTemplate").html());
    prize.digit0 = null;
    prize.digit1 = null; 


    prize._randomSelect = function(chooseTime){
        if(prize.digit0 == null){
            prize.digit0 = prize.randomNumber();
        }else{
            prize.digit1 = prize.randomNumber();
        }

        console.log("prize.digit0:"+prize.digit0);
        console.log("prize.digit1:"+prize.digit1);


    }

    prize._randomNumberGen = function(){
        if(prize.isFinish()){
            prize.digit0 = null;
            prize.digit1 = null;
        }
        var content = prize.numbersTpl({prize:prize});
        $(".prize-program").html(content)
    }

    prize.isFinish = function(){
        return prize.digit0!= null && prize.digit1 != null
    }

    prize.run = function(running){
        if(running){
            prize._randomSelect(prize.selectPerTime);
            if(prize.isFinish()){
                window.clearInterval(running);
                prize.save()
                var content = prize.numbersTpl({prize:prize});
                $(".prize-program").html(content)
                running = false;
            }else{
            }
            
        }else{
            running = window.setInterval(function(){

                        prize._randomNumberGen();


          }, 1)
        }
        return running
    }



    return prize;


}



exports.Prize = Prize;
exports.SpecialPrize = SpecialPrize;
exports.SinglePrize = SinglePrize;

