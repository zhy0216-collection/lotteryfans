<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>Lottery 2014</title>
    <link rel='stylesheet'  href='./style.css' type='text/css' media='screen' />
    <script type="text/javascript" src="./node_modules/jquery/dist/jquery.js"></script>
    <script type="text/javascript">
        require('nw.gui').Window.get().showDevTools() 

        _ = require("underscore")
        PeopleList = require("people").PeopleList;
        People = require("people").People;
        
        function restore(){
            if(!localStorage.peopleList){
                return null;
            }
            var peopleData = JSON.parse(localStorage.peopleList)
            var peopleList = new PeopleList();
            _.each(peopleData, function(element, index, list){
                var people = new People(element.id, element.name, element.selected);
                peopleList.addPeople(people);
            })
            return peopleList;
        }

        function showResult(selectedPeopleList){
            console.log(selectedPeopleList);
        }


        $(function(){
            var peopleTemplate = require("swig").compile($("#peopleTemplate").html());
            var peopleList = restore() || (new PeopleList()).initFromFile("./res/text.txt");
            var running = false;
            console.log(peopleList.getPeopleList());
            //init unknow
            for(var i=0;i < 6; i++){
                $(".people-row").append($("#unknowPeopleTemplate").html())
            }

            function _randomSelect(select){
                $(".people").each(function(){
                    var people = peopleList.randomSelect(select);
                    $(this).replaceWith(peopleTemplate({people:people}));
                })
            }

            $(document).on("keyup", function(e){
                if(e.which == 32 || e.which == 13){ // spacebar or enter 
                    if(running){
                        clearInterval(running);
                        _randomSelect(true);
                        peopleList.save();
                        running = false;
                    }else{
                        running = setInterval(function(){
                                    _randomSelect(false);
                                  }, 1)
                        console.log(running)
                    }
                }else if(e.which == 82){ //r
                    showResult(peopleList.getSelectPeople());
                }

            })

        })


    </script>
  </head>
  <body>
        <div id="people-container">
            <div class="people-row">
                
            </div>
            <div class="people-row">
            </div>
        </div>

        <div id="people-result-container">

        </div>



    <script type="text/template" id="unknowPeopleTemplate">
        <div class="people people-unknow">
            <img src="./res/icon_background_big_unknown.png">
        </div>
    </script>

    <script type="text/template" id="peopleTemplate">
        <div class="people">
            <div class="people-card">
                <div class="people-font">{{people.name}}</div>
                <div class="people-font">{{people.id}}</div>
            </div>
        </div>
    </script>

    <script type="text/template" id="resultTemplate">
        <ul>
            {%for people in peopleList%}
            <li>
                <span>{{people.name}}</span>
                <span>{{people.id}}</span>
            </li>
            {%endfor%}
        </ul>

    </script>

  </body>
</html>